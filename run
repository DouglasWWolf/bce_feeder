REG_BC_COUNT=0x1078

show_bc_count()
{
    printf "\b\b\b\b\b\b\b\b%8u" $(pcireg -dec $REG_BC_COUNT)
}

clear

# Tell the user what we're doing
echo "Initializing bce_feeder"

# Set the count of bright-cycles completed to 0
pcireg $REG_BC_COUNT 0
sudo ./bce_feeder.x86 -repeat 5 &
pid=$!

# Here we are going to sit in a loop until either
# the first bright-cycle has been sent or until the
# bce_feeder software exits due to some error
while :; do
    complete=$(pcireg -dec $REG_BC_COUNT)
    test $complete -ne 0 && break
    ps -p $pid >/dev/null
    if [ $? -ne 0 ]; then
        echo "bce_feeder stopped!"
        exit 1
    fi
    sleep .5
done


# Here we display the number of bright-cycles completed
# until the job is done
printf "Bright Cycles:        0"
while :; do
    show_bc_count
    ps -p $pid >/dev/null
    test $? -ne 0 && break
    sleep 1
done
show_bc_count
printf "\n"
echo "Done!"
